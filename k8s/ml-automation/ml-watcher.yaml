apiVersion: apps/v1
kind: Deployment
metadata:
  name: ml-config-watcher
  namespace: giovanamachado
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ml-config-watcher
  template:
    metadata:
      labels:
        app: ml-config-watcher
    spec:
      serviceAccountName: ml-updater-sa
      containers:
      - name: watcher
        image: bitnami/kubectl:latest
        command:
        - /bin/bash
        - -c
        - |
          #!/bin/bash
          set -e
          
          echo "=== ML Config Watcher Started ==="
          echo "Monitoring ConfigMap changes every 30 seconds..."
          
          LAST_HASH=""
          
          while true; do
            # Get current ConfigMap hash
            CURRENT_HASH=$(kubectl get configmap playlist-config -n giovanamachado -o yaml | sha256sum | cut -d' ' -f1)
            
            # Create job if ConfigMap changed OR if this is the first run
            if [ "$LAST_HASH" != "$CURRENT_HASH" ]; then
              if [ -z "$LAST_HASH" ]; then
                echo "=== Initial run - Creating first ML job ==="
              else
                echo "=== ConfigMap changed! ==="
                echo "Old hash: $LAST_HASH"
                echo "New hash: $CURRENT_HASH"
              fi
              
              # Get dataset info
              DATASET_NAME=$(kubectl get configmap playlist-config -n giovanamachado -o jsonpath='{.data.DATASET_NAME}')
              TIMESTAMP=$(date +%Y%m%d-%H%M%S)
              JOB_NAME="ml-job-${DATASET_NAME}-${TIMESTAMP}"
              
              echo "Creating ML job: $JOB_NAME for dataset: $DATASET_NAME"
              
              # Create job from ConfigMap values
              kubectl apply -f - <<EOF
              apiVersion: batch/v1
              kind: Job
              metadata:
                name: ${JOB_NAME}
                namespace: giovanamachado
                labels:
                  app: giovanamachado-playlist-ml
                  dataset: ${DATASET_NAME}
                  auto-generated: "true"
              spec:
                ttlSecondsAfterFinished: 3600
                template:
                  metadata:
                    labels:
                      app: giovanamachado-playlist-ml
                  spec:
                    restartPolicy: Never
                    containers:
                    - name: ml-generator
                      image: docker.io/giovana2ma/playlists-ml:0.2
                      imagePullPolicy: Always
                      command: ["/bin/sh", "-c"]
                      args:
                        - |
                          set -e
                          echo "Starting ML job for dataset: \$DATASET_PATH"
                          echo "Output will be saved to: /output/\$MODEL_FILENAME"
                          python3 ruleGenerator.py \$DATASET_PATH -o /output/\$MODEL_FILENAME -s \$MIN_SUPPORT -c \$MIN_CONFIDENCE -l \$MIN_LIFT
                          echo "Model generated successfully!"
                          ls -lh /output/
                      env:
                      - name: DATASET_PATH
                        valueFrom:
                          configMapKeyRef:
                            name: playlist-config
                            key: DATASET_URL
                      - name: MODEL_FILENAME
                        valueFrom:
                          configMapKeyRef:
                            name: playlist-config
                            key: MODEL_FILENAME
                      - name: MIN_SUPPORT
                        valueFrom:
                          configMapKeyRef:
                            name: playlist-config
                            key: MIN_SUPPORT
                      - name: MIN_CONFIDENCE
                        valueFrom:
                          configMapKeyRef:
                            name: playlist-config
                            key: MIN_CONFIDENCE
                      - name: MIN_LIFT
                        valueFrom:
                          configMapKeyRef:
                            name: playlist-config
                            key: MIN_LIFT
                      resources:
                        limits:
                          memory: "1Gi"
                        requests:
                          memory: "1Gi"
                      volumeMounts:
                      - name: dataset-volume
                        mountPath: /home/datasets/spotify
                        readOnly: true
                      - name: model-volume
                        mountPath: /output
                    volumes:
                    - name: dataset-volume
                      hostPath:
                        path: /home/datasets/spotify
                        type: Directory
                    - name: model-volume
                      persistentVolumeClaim:
                        claimName: project2-pvc
          EOF
              
              echo "✓ Job created: $JOB_NAME"
              
              # Wait a bit before restarting deployment
              sleep 5
              
              # Restart deployment to pick up new model
              kubectl rollout restart deployment/playlist-recommender -n giovanamachado
              echo "✓ Deployment restart triggered"
            fi
            
            LAST_HASH=$CURRENT_HASH
            sleep 30
          done
